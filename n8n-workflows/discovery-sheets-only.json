{
  "name": "FlipOps Discovery - Sheets Only Test",
  "nodes": [
    {
      "parameters": {},
      "name": "Manual Trigger",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [250, 300]
    },
    {
      "parameters": {
        "operation": "read",
        "documentId": {
          "__rl": true,
          "value": "1TwEzCOn-2FygrJ3jSTixzXgdknMmn-I_AiuHaCPjJKY",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": "Properties",
          "mode": "name"
        },
        "options": {}
      },
      "name": "Read Google Sheet",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 2,
      "position": [450, 300]
    },
    {
      "parameters": {
        "functionCode": "// Normalize Google Sheets data\nreturn items.map(i => {\n  const r = i.json;\n  return {\n    json: {\n      type: \"property\",\n      source: \"sheets-intake\",\n      property: {\n        address1: r.address || r.Address || '',\n        city: r.city || r.City || '',\n        state: r.state || r.State || \"FL\",\n        zip: String(r.zip ?? r.ZIP ?? \"\"),\n        apn: r.apn || r.APN || null,\n        ownerName: r.ownerName || r.Owner || null\n      },\n      flags: {\n        foreclosure: r.foreclosure === true || r.foreclosure === 'true',\n        preForeclosure: r.preForeclosure === true || r.preForeclosure === 'true',\n        taxDelinquent: r.taxDelinquent === true || r.taxDelinquent === 'true',\n        vacant: r.vacant === true || r.vacant === 'true',\n        bankruptcy: r.bankruptcy === true || r.bankruptcy === 'true',\n        absenteeOwner: r.absenteeOwner === true || r.absenteeOwner === 'true'\n      },\n      metadata: {\n        scrapeUrl: null,\n        recordedAt: null,\n        ingestedAt: new Date().toISOString(),\n        raw: r\n      }\n    }\n  };\n});"
      },
      "name": "Normalize",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [650, 300]
    },
    {
      "parameters": {
        "functionCode": "// Add idempotency key\nfunction norm(s) {\n  return (s || '').toUpperCase().replace(/[^\\w\\s]/g, '').replace(/\\s+/g, ' ').trim();\n}\n\nreturn items.map(i => {\n  const p = i.json.property || {};\n  const addrKey = [norm(p.address1), norm(p.city), norm(p.state), norm(p.zip)].join('|');\n  const key = p.apn ? norm(p.apn) : addrKey + '|' + norm(p.ownerName || '');\n  \n  i.json._idempotency = key;\n  \n  // Add a simple score for testing\n  let score = 50;\n  if (i.json.flags.foreclosure) score += 25;\n  if (i.json.flags.preForeclosure) score += 20;\n  if (i.json.flags.taxDelinquent) score += 15;\n  if (i.json.flags.vacant) score += 10;\n  if (i.json.flags.absenteeOwner) score += 5;\n  i.json.score = Math.min(score, 100);\n  \n  return i;\n});"
      },
      "name": "Add Idempotency & Score",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [850, 300]
    },
    {
      "parameters": {
        "conditions": {
          "number": [
            {
              "value1": "={{$json.score}}",
              "operation": "largerEqual",
              "value2": 70
            }
          ]
        }
      },
      "name": "High Score?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [1050, 300]
    },
    {
      "parameters": {
        "resource": "message",
        "operation": "post",
        "channel": "C09JDCY5SKH",
        "text": "=ðŸ  *Property Discovery Test*\\n\\n*Source:* {{$json.source}}\\n*Address:* {{$json.property.address1}}, {{$json.property.city}}, {{$json.property.state}}\\n*Score:* {{$json.score}}/100\\n*ID:* {{$json._idempotency}}\\n\\n*Flags:*\\n{{Object.entries($json.flags).filter(([k,v]) => v).map(([k,v]) => `â€¢ ${k}: âœ“`).join('\\n')}}",
        "otherOptions": {}
      },
      "name": "Slack Alert",
      "type": "n8n-nodes-base.slack",
      "typeVersion": 2,
      "position": [1250, 250]
    },
    {
      "parameters": {
        "functionCode": "// Summary\nconst total = items.length;\nconst highScore = items.filter(i => i.json.score >= 70).length;\n\nreturn [{\n  json: {\n    summary: `Processed ${total} properties, ${highScore} high-score`,\n    total,\n    highScore,\n    properties: items.map(i => ({\n      address: i.json.property.address1,\n      score: i.json.score,\n      id: i.json._idempotency\n    }))\n  }\n}];"
      },
      "name": "Create Summary",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1250, 450]
    }
  ],
  "connections": {
    "Manual Trigger": {
      "main": [
        [
          {
            "node": "Read Google Sheet",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Read Google Sheet": {
      "main": [
        [
          {
            "node": "Normalize",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Normalize": {
      "main": [
        [
          {
            "node": "Add Idempotency & Score",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Add Idempotency & Score": {
      "main": [
        [
          {
            "node": "High Score?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "High Score?": {
      "main": [
        [
          {
            "node": "Slack Alert",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Create Summary",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {}
}