// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User/Investor - Multi-tenant support
model User {
  id              String    @id @default(cuid())
  email           String    @unique
  clerkId         String?   @unique // Clerk auth ID
  name            String?
  companyName     String?

  // Investment preferences
  targetMarkets   String    // JSON array: ["Miami-Dade, FL", "Maricopa, AZ"]
  propertyTypes   String?   // JSON array: ["single_family", "multi_family"]
  minScore        Int       @default(70) // Minimum property score to alert
  maxBudget       Float?    // Maximum deal budget

  // Detailed investor profile for personalized lead generation
  investorProfile String?   // JSON: { strategies, priceRanges, distressWeights, dealBreakers, etc. }

  // Notification preferences
  slackWebhook    String?   // User-specific Slack webhook
  emailAlerts     Boolean   @default(true)
  dailyDigest     Boolean   @default(true)
  digestTime      String?   // Time for daily digest (e.g., "08:00")
  timezone        String    @default("America/New_York")

  // Subscription & billing
  tier            String    @default("pro") // free, pro, enterprise
  monthlyDeals    Int       @default(0) // Track usage for tiered pricing
  subscriptionStatus String @default("active") // active, paused, cancelled

  // Platform settings
  onboarded       Boolean   @default(false)
  onboardedAt     DateTime?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  lastLoginAt     DateTime?

  // Relations
  properties      Property[]
  deals           DealSpec[]
  policies        Policy[]
  vendors         Vendor[]
  tasks           Task[]
  dealAnalyses    DealAnalysis[]
  offers          Offer[]

  @@index([email])
  @@index([clerkId])
  @@index([tier])
}

// Core deal specification
model DealSpec {
  id              String    @id @default(cuid())
  userId          String    // Multi-tenant: which investor owns this deal
  address         String
  type            String    // SFH, multi-family, commercial
  maxExposureUsd  Float
  targetRoiPct    Float
  arv             Float?    // After Repair Value for ROI calculations
  region          String?   @default("Miami")
  grade           String?   @default("Standard")
  startAt         DateTime?
  dailyBurnUsd    Float?    @default(0)
  constraints     String    // Array of constraint objects (JSON string)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  scopeNodes      ScopeTreeNode[]
  bids            Bid[]
  changeOrders    ChangeOrder[]
  events          Event[]
  budgetLedger    BudgetLedger?
  tasks           Task[]

  @@index([userId])
  @@index([address])
  @@index([createdAt])
}

// Scope tree for work breakdown
model ScopeTreeNode {
  id          String    @id @default(cuid())
  dealId      String
  trade       String    // HVAC, Plumbing, Electrical, etc.
  task        String    // Specific task within trade
  quantity    Json      // {value: number, unit: string, method: string}
  finishLvl   String?   // Standard, Premium, Luxury
  assumptions Json      // Array of assumption strings (stored as JSON for SQLite)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  deal        DealSpec  @relation(fields: [dealId], references: [id], onDelete: Cascade)

  @@unique([dealId, trade, task])
  @@index([dealId])
  @@index([trade])
}

// Cost model for estimation
model CostModel {
  id              String    @id @default(cuid())
  region          String    // Geographic region
  grade           String    // Standard, Premium, Luxury
  trade           String    // Trade category
  task            String    // Specific task
  unit            String    // sqft, lf, ea, etc.
  material        Float     // Material cost per unit
  labor           Float     // Labor cost per unit
  contingencyPct  Float     // Default contingency percentage
  riskPremiumPct  Float     // Risk premium percentage
  source          String?   // Data source
  updatedAt       DateTime  @updatedAt
  createdAt       DateTime  @default(now())

  @@unique([region, grade, trade, task, unit])
  @@index([region, grade])
  @@index([trade, task])
}

// Budget tracking ledger
model BudgetLedger {
  dealId              String    @id
  baseline            String      // Baseline budget by trade
  committed           String      // Committed costs by trade
  actuals             String      // Actual costs by trade
  variance            String      // Variance analysis by trade
  contingencyRemaining Float    // Remaining contingency
  updatedAt           DateTime  @updatedAt
  createdAt           DateTime  @default(now())

  // Relations
  deal                DealSpec  @relation(fields: [dealId], references: [id], onDelete: Cascade)
}

// Vendor bid tracking
model Bid {
  id          String    @id @default(cuid())
  dealId      String
  vendorId    String
  items       String      // Array of bid line items: {trade, task, quantity, unit, unitPrice, totalPrice}
  subtotal    Float
  includes    Json      // What's included (stored as JSON for SQLite)
  excludes    Json      // What's excluded (stored as JSON for SQLite)
  status      String    @default("pending") // pending, awarded, rejected
  normalized  Json?     // Normalized bid data for comparison
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  deal        DealSpec  @relation(fields: [dealId], references: [id], onDelete: Cascade)
  vendor      Vendor?   @relation(fields: [vendorId], references: [id])

  @@index([dealId])
  @@index([vendorId])
  @@index([status])
}

// Change order management
model ChangeOrder {
  id          String    @id @default(cuid())
  dealId      String
  trade       String
  deltaUsd    Float     // Cost change
  impactDays  Int       // Schedule impact in days
  status      String    // proposed, approved, denied
  rationale   String?   // Reason for change or denial
  simResults  Json?     // Simulation results cache
  decidedAt   DateTime? // When decision was made
  decidedBy   String?   // Who/what made the decision
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  deal        DealSpec  @relation(fields: [dealId], references: [id], onDelete: Cascade)

  @@index([dealId])
  @@index([status])
  @@index([trade])
}

// Immutable event log
model Event {
  id          String    @id @default(cuid())
  dealId      String?
  actor       String    // User ID or system component
  artifact    String    // What was affected (DealSpec, Bid, etc.)
  action      String    // CREATE, UPDATE, DELETE, APPROVE, BLOCK, etc.
  diff        String?     // JSON Patch diff
  checksum    String    // SHA-256 hash for integrity
  ts          DateTime  @default(now())

  // Relations
  deal        DealSpec? @relation(fields: [dealId], references: [id], onDelete: Cascade)

  @@index([dealId])
  @@index([actor])
  @@index([artifact])
  @@index([ts])
}

// Vendor management
model Vendor {
  id              String    @id @default(cuid())
  userId          String?   // Multi-tenant: user-specific vendor, null = shared/platform vendor
  name            String
  email           String?
  phone           String?
  trade           String      // Array of trades they handle (stored as JSON for SQLite)
  region          String?
  onTimePct       Float     @default(100) // On-time percentage
  onBudgetPct     Float     @default(100) // On-budget percentage
  reliability     Float     @default(100) // Overall reliability score
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  user            User?     @relation(fields: [userId], references: [id], onDelete: Cascade)
  bids            Bid[]
  invoices        Invoice[]

  @@index([userId])
  @@index([trade])
  @@index([region])
}

// Invoice tracking
model Invoice {
  id          String    @id @default(cuid())
  dealId      String
  vendorId    String?
  trade       String
  lineItemId  String?   // Optional link to specific line item
  amount      Float
  docUrl      String?   // S3 URL to document
  status      String    @default("pending") // pending, approved, paid
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  vendor      Vendor?   @relation(fields: [vendorId], references: [id])

  @@index([dealId])
  @@index([vendorId])
  @@index([status])
}

// Policy configuration by region and grade
model Policy {
  id                   String    @id @default(cuid())
  userId               String?   // Multi-tenant: user-specific policy, null = global default
  region               String
  grade                String    // Standard, Premium, Luxury
  maxExposureUsd       Float
  targetRoiPct         Float
  contingencyTargetPct Float
  varianceTier1Pct     Float    // 3% default
  varianceTier2Pct     Float    // 7% default
  bidSpreadMaxPct      Float    // 15% default
  coSlaHours           Int       // Change order SLA in hours
  updatedBy            String?
  updatedAt            DateTime  @updatedAt
  createdAt            DateTime  @default(now())

  // Relations
  user                 User?     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, region, grade])
  @@index([userId])
  @@index([region, grade])
}

// Property discovery and scoring
model Property {
  id               String   @id @default(cuid())
  userId           String   // Multi-tenant: which investor owns this property lead
  address          String
  city             String
  state            String
  zip              String
  county           String?
  apn              String?  // Assessor Parcel Number
  ownerName        String?

  // Property details
  propertyType     String?
  bedrooms         Int?
  bathrooms        Int?
  squareFeet       Int?
  lotSize          Int?
  yearBuilt        Int?

  // Financial
  assessedValue    Float?
  taxAmount        Float?
  lastSaleDate     String?
  lastSalePrice    Float?
  estimatedValue   Float?

  // Scoring (optional until calculated)
  score            Int?
  scoreBreakdown   String?  // JSON string with score details
  scoredAt         DateTime?
  potentialProfit  Float?

  // Distress flags
  foreclosure      Boolean  @default(false)
  preForeclosure   Boolean  @default(false)
  taxDelinquent    Boolean  @default(false)
  vacant           Boolean  @default(false)
  bankruptcy       Boolean  @default(false)
  absenteeOwner    Boolean  @default(false)

  // Contact info (from skip tracing)
  phoneNumbers     String?  // JSON array
  emails           String?  // JSON array

  // Outreach tracking (sales workflow)
  outreachStatus      String?   @default("not_contacted")
  // Status values: "not_contacted", "attempted", "contacted", "offer_made",
  //                "negotiating", "under_contract", "dead", "closed"
  lastContactDate     DateTime?
  lastContactMethod   String?   // "phone", "email", "sms", "in_person"
  contactNotes        String?   // JSON array: [{date, note, method, sentiment}]
  ownerResponse       String?   // "interested", "not_interested", "callback", "no_answer"
  nextFollowUpDate    DateTime?
  sentiment           String?   // "positive", "neutral", "negative"

  // Offer tracking
  offerAmount         Float?
  offerDate           DateTime?
  offerStatus         String?   // "draft", "sent", "countered", "accepted", "rejected"

  // Source tracking
  dataSource       String
  sourceId         String?
  enriched         Boolean  @default(false)

  // Metadata
  metadata         String?  // Additional flexible data (JSON string for SQLite)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  user             User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  tasks            Task[]
  dealAnalyses     DealAnalysis[]
  offers           Offer[]

  @@unique([userId, address, city, state, zip])
  @@index([userId])
  @@index([score])
  @@index([city, state])
  @@index([createdAt])
  @@index([dataSource])
}

// Task management for investor workflow
model Task {
  id          String   @id @default(cuid())
  userId      String   // Multi-tenant: which investor owns this task
  propertyId  String?  // Optional link to property
  dealId      String?  // Optional link to deal/renovation

  type        String   // "call", "email", "text", "showing", "offer", "follow_up", "custom"
  title       String
  description String?
  dueDate     DateTime
  completed   Boolean  @default(false)
  completedAt DateTime?
  priority    String   @default("medium") // "low", "medium", "high"

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  property    Property? @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  deal        DealSpec? @relation(fields: [dealId], references: [id], onDelete: Cascade)

  @@index([userId, dueDate])
  @@index([userId, completed])
  @@index([propertyId])
  @@index([dealId])
}

// Deal analysis and underwriting
model DealAnalysis {
  id            String   @id @default(cuid())
  userId        String   // Multi-tenant: which investor owns this analysis
  propertyId    String   // Link to property being analyzed

  // ARV (After Repair Value) calculation
  arv           Float
  arvMethod     String   // "median", "weighted", "knn", "manual"
  compsUsed     String?  // JSON array of comparable property data

  // Repair costs
  repairTotal   Float
  repairItems   String?  // JSON array of {category, description, cost}

  // Offer calculation
  maxOffer      Float    // Maximum offer based on rule
  rule          String   @default("70%") // "70%", "75%", "custom"
  offerAmount   Float?   // Actual offer if different from max

  // Purchase and holding costs
  purchasePrice Float?   // Actual purchase price if known
  closingCosts  Float?   // Estimated closing costs
  holdingCosts  Float?   // Monthly holding costs
  holdingMonths Int?     // Expected holding period

  // Profit analysis
  sellingCosts  Float?   // Estimated selling costs (realtor, etc.)
  projectedProfit Float? // Expected profit
  roi           Float?   // Return on investment percentage

  // Metadata
  name          String?  // Optional name for this analysis (e.g., "Conservative", "Aggressive")
  notes         String?  // User notes about this analysis
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  property      Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([propertyId])
}

// Offer management and tracking
model Offer {
  id            String    @id @default(cuid())
  userId        String    // Multi-tenant: which investor owns this offer
  propertyId    String    // Property being offered on
  analysisId    String?   // Optional link to deal analysis

  // Offer details
  amount        Float
  terms         String?   // "cash", "financing", "seller_financing", "subject_to"
  contingencies String?   // JSON array: ["inspection", "financing", "appraisal", "sale_of_home"]
  closingDate   DateTime?
  expiresAt     DateTime? // When offer expires if not accepted
  earnestMoney  Float?    // Earnest money deposit amount
  dueDate       DateTime? // Date offer is due/presented

  // Status tracking
  status        String    @default("draft") // "draft", "sent", "countered", "accepted", "rejected", "expired"
  sentAt        DateTime?
  responseAt    DateTime?
  responseNotes String?   // Notes about seller's response

  // Counter-offer tracking
  counterAmount Float?    // If seller countered
  counterTerms  String?   // JSON with counter-offer details
  counterDate   DateTime?

  // Documentation
  documentUrl   String?   // Link to offer letter/PDF
  notes         String?   // Internal notes about this offer

  // Metadata
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  property      Property  @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@index([userId, status])
  @@index([propertyId])
  @@index([status])
  @@index([createdAt])
}

// Notification and event tracking
model Notification {
  id          String   @id @default(cuid())
  eventId     String   @unique
  type        String   // g1.denied, property.alert, etc.
  dealId      String?
  message     String
  metadata    String?  // Flexible metadata including dedupe_hash (JSON string for SQLite)
  occurredAt  DateTime @default(now())
  createdAt   DateTime @default(now())
  n8nExecId   String?  // n8n execution ID
  n8nWorkflow String?  // n8n workflow name
  processed   Boolean  @default(false)

  @@index([type, occurredAt])
  @@index([dealId])
  @@index([processed])
}
