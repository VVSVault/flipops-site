// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User/Investor - Multi-tenant support
model User {
  id              String    @id @default(cuid())
  email           String    @unique
  clerkId         String?   @unique // Clerk auth ID
  name            String?
  companyName     String?

  // Investment preferences
  targetMarkets   String    // JSON array: ["Miami-Dade, FL", "Maricopa, AZ"]
  propertyTypes   String?   // JSON array: ["single_family", "multi_family"]
  minScore        Int       @default(70) // Minimum property score to alert
  maxBudget       Float?    // Maximum deal budget

  // Detailed investor profile for personalized lead generation
  investorProfile String?   // JSON: { strategies, priceRanges, distressWeights, dealBreakers, etc. }

  // Investor type and multi-strategy support
  investorType       String?   // "wholesaler", "flipper", "buy_and_hold", "hybrid"
  onboardingComplete Boolean   @default(false)

  // Notification preferences
  slackWebhook    String?   // User-specific Slack webhook
  emailAlerts     Boolean   @default(true)
  dailyDigest     Boolean   @default(true)
  digestTime      String?   // Time for daily digest (e.g., "08:00")
  timezone        String    @default("America/New_York")

  // Subscription & billing
  tier            String    @default("pro") // free, pro, enterprise
  monthlyDeals    Int       @default(0) // Track usage for tiered pricing
  subscriptionStatus String @default("active") // active, paused, cancelled

  // Platform settings
  onboarded       Boolean   @default(false)
  onboardedAt     DateTime?
  currency        String    @default("USD")

  // Email signature settings
  emailSignatureEnabled Boolean @default(false)
  emailSenderName       String?
  emailCompanyName      String?
  emailSignature        String?

  // Team settings
  currentTeamId   String?   // Currently active team for this user

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  lastLoginAt     DateTime?

  // Relations
  properties      Property[]
  deals           DealSpec[]
  policies        Policy[]
  vendors         Vendor[]        // Legacy vendor model (to be deprecated)
  tasks           Task[]
  dealAnalyses    DealAnalysis[]
  offers          Offer[]
  contracts       Contract[]
  buyers          Buyer[]
  rentals         Rental[]
  buyerOffers     BuyerOffer[]
  campaigns       Campaign[]

  // New Vendor Network System relations
  userVendors           UserVendor[]              // User's private vendors
  vendorRelationships   UserVendorRelationship[]  // User's relationships with platform vendors
  vendorJobs            VendorJob[]               // User's job history with vendors

  @@index([email])
  @@index([clerkId])
  @@index([tier])
  @@index([currentTeamId])
}

// Core deal specification
model DealSpec {
  id              String    @id @default(cuid())
  userId          String    // Multi-tenant: which investor owns this deal
  propertyId      String?   // Link to property (for flippers starting renovation)
  contractId      String?   @unique // Link to contract (for flippers starting renovation)
  address         String
  type            String    // SFH, multi-family, commercial
  maxExposureUsd  Float
  targetRoiPct    Float
  arv             Float?    // After Repair Value for ROI calculations
  region          String?   @default("Miami")
  grade           String?   @default("Standard")
  status          String    @default("planning") // "planning", "active", "on_hold", "completed", "cancelled"
  startAt         DateTime?
  completedAt     DateTime? // When renovation was completed
  dailyBurnUsd    Float?    @default(0)
  constraints     String    // Array of constraint objects (JSON string)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  property        Property? @relation(fields: [propertyId], references: [id], onDelete: SetNull)
  contract        Contract? @relation(fields: [contractId], references: [id], onDelete: SetNull)
  scopeNodes      ScopeTreeNode[]
  bids            Bid[]
  changeOrders    ChangeOrder[]
  events          Event[]
  budgetLedger    BudgetLedger?
  tasks           Task[]
  vendorJobs      VendorJob[] // Jobs assigned to vendors for this renovation

  @@index([userId])
  @@index([propertyId])
  @@index([contractId])
  @@index([address])
  @@index([status])
  @@index([createdAt])
}

// Scope tree for work breakdown
model ScopeTreeNode {
  id          String    @id @default(cuid())
  dealId      String
  trade       String    // HVAC, Plumbing, Electrical, etc.
  task        String    // Specific task within trade
  quantity    Json      // {value: number, unit: string, method: string}
  finishLvl   String?   // Standard, Premium, Luxury
  assumptions Json      // Array of assumption strings (stored as JSON for SQLite)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  deal        DealSpec  @relation(fields: [dealId], references: [id], onDelete: Cascade)

  @@unique([dealId, trade, task])
  @@index([dealId])
  @@index([trade])
}

// Cost model for estimation
model CostModel {
  id              String    @id @default(cuid())
  region          String    // Geographic region
  grade           String    // Standard, Premium, Luxury
  trade           String    // Trade category
  task            String    // Specific task
  unit            String    // sqft, lf, ea, etc.
  material        Float     // Material cost per unit
  labor           Float     // Labor cost per unit
  contingencyPct  Float     // Default contingency percentage
  riskPremiumPct  Float     // Risk premium percentage
  source          String?   // Data source
  updatedAt       DateTime  @updatedAt
  createdAt       DateTime  @default(now())

  @@unique([region, grade, trade, task, unit])
  @@index([region, grade])
  @@index([trade, task])
}

// Budget tracking ledger
model BudgetLedger {
  dealId              String    @id
  baseline            String      // Baseline budget by trade
  committed           String      // Committed costs by trade
  actuals             String      // Actual costs by trade
  variance            String      // Variance analysis by trade
  contingencyRemaining Float    // Remaining contingency
  updatedAt           DateTime  @updatedAt
  createdAt           DateTime  @default(now())

  // Relations
  deal                DealSpec  @relation(fields: [dealId], references: [id], onDelete: Cascade)
}

// Vendor bid tracking
model Bid {
  id          String    @id @default(cuid())
  dealId      String
  vendorId    String
  items       String      // Array of bid line items: {trade, task, quantity, unit, unitPrice, totalPrice}
  subtotal    Float
  includes    Json      // What's included (stored as JSON for SQLite)
  excludes    Json      // What's excluded (stored as JSON for SQLite)
  status      String    @default("pending") // pending, awarded, rejected
  normalized  Json?     // Normalized bid data for comparison
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  deal        DealSpec  @relation(fields: [dealId], references: [id], onDelete: Cascade)
  vendor      Vendor?   @relation(fields: [vendorId], references: [id])

  @@index([dealId])
  @@index([vendorId])
  @@index([status])
}

// Change order management
model ChangeOrder {
  id          String    @id @default(cuid())
  dealId      String
  trade       String
  deltaUsd    Float     // Cost change
  impactDays  Int       // Schedule impact in days
  status      String    // proposed, approved, denied
  rationale   String?   // Reason for change or denial
  simResults  Json?     // Simulation results cache
  decidedAt   DateTime? // When decision was made
  decidedBy   String?   // Who/what made the decision
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  deal        DealSpec  @relation(fields: [dealId], references: [id], onDelete: Cascade)

  @@index([dealId])
  @@index([status])
  @@index([trade])
}

// Immutable event log
model Event {
  id          String    @id @default(cuid())
  dealId      String?
  actor       String    // User ID or system component
  artifact    String    // What was affected (DealSpec, Bid, etc.)
  action      String    // CREATE, UPDATE, DELETE, APPROVE, BLOCK, etc.
  diff        String?     // JSON Patch diff
  checksum    String    // SHA-256 hash for integrity
  ts          DateTime  @default(now())

  // Relations
  deal        DealSpec? @relation(fields: [dealId], references: [id], onDelete: Cascade)

  @@index([dealId])
  @@index([actor])
  @@index([artifact])
  @@index([ts])
}

// LEGACY: Vendor management (being replaced by Vendor Network System below)
// Migration: Data will move to UserVendor (for user-created vendors)
// Keep for now to maintain Bid/Invoice relations during transition
model Vendor {
  id              String    @id @default(cuid())
  userId          String?   // Multi-tenant: user-specific vendor, null = shared/platform vendor
  name            String
  email           String?
  phone           String?
  trade           String      // Array of trades they handle (stored as JSON for SQLite)
  region          String?
  onTimePct       Float     @default(100) // On-time percentage
  onBudgetPct     Float     @default(100) // On-budget percentage
  reliability     Float     @default(100) // Overall reliability score
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  user            User?     @relation(fields: [userId], references: [id], onDelete: Cascade)
  bids            Bid[]
  invoices        Invoice[]

  @@index([userId])
  @@index([trade])
  @@index([region])
}

// Invoice tracking
model Invoice {
  id          String    @id @default(cuid())
  dealId      String
  vendorId    String?
  trade       String
  lineItemId  String?   // Optional link to specific line item
  amount      Float
  docUrl      String?   // S3 URL to document
  status      String    @default("pending") // pending, approved, paid
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  vendor      Vendor?   @relation(fields: [vendorId], references: [id])

  @@index([dealId])
  @@index([vendorId])
  @@index([status])
}

// Policy configuration by region and grade
model Policy {
  id                   String    @id @default(cuid())
  userId               String?   // Multi-tenant: user-specific policy, null = global default
  region               String
  grade                String    // Standard, Premium, Luxury
  maxExposureUsd       Float
  targetRoiPct         Float
  contingencyTargetPct Float
  varianceTier1Pct     Float    // 3% default
  varianceTier2Pct     Float    // 7% default
  bidSpreadMaxPct      Float    // 15% default
  coSlaHours           Int       // Change order SLA in hours
  updatedBy            String?
  updatedAt            DateTime  @updatedAt
  createdAt            DateTime  @default(now())

  // Relations
  user                 User?     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, region, grade])
  @@index([userId])
  @@index([region, grade])
}

// Property discovery and scoring
model Property {
  id               String   @id @default(cuid())
  userId           String   // Multi-tenant: which investor owns this property lead
  address          String
  city             String
  state            String
  zip              String
  county           String?
  apn              String?  // Assessor Parcel Number
  ownerName        String?

  // Property details
  propertyType     String?
  bedrooms         Int?
  bathrooms        Int?
  squareFeet       Int?
  lotSize          Int?
  yearBuilt        Int?

  // Financial
  assessedValue    Float?
  taxAmount        Float?
  lastSaleDate     String?
  lastSalePrice    Float?
  estimatedValue   Float?

  // Listing/Market info
  listingDate      DateTime?  // When property was listed
  daysOnMarket     Int?       // Calculated or provided DOM

  // Scoring (optional until calculated)
  score            Int?
  scoreBreakdown   String?  // JSON string with score details
  scoredAt         DateTime?
  potentialProfit  Float?

  // Distress flags
  foreclosure      Boolean  @default(false)
  preForeclosure   Boolean  @default(false)
  taxDelinquent    Boolean  @default(false)
  vacant           Boolean  @default(false)
  bankruptcy       Boolean  @default(false)
  absenteeOwner    Boolean  @default(false)

  // Contact info (from skip tracing)
  phoneNumbers     String?  // JSON array
  emails           String?  // JSON array

  // Outreach tracking (sales workflow)
  outreachStatus      String?   @default("not_contacted")
  // Status values: "not_contacted", "attempted", "contacted", "offer_made",
  //                "negotiating", "under_contract", "dead", "closed"
  lastContactDate     DateTime?
  lastContactMethod   String?   // "phone", "email", "sms", "in_person"
  contactNotes        String?   // JSON array: [{date, note, method, sentiment}]
  ownerResponse       String?   // "interested", "not_interested", "callback", "no_answer"
  nextFollowUpDate    DateTime?
  sentiment           String?   // "positive", "neutral", "negative"

  // Offer tracking
  offerAmount         Float?
  offerDate           DateTime?
  offerStatus         String?   // "draft", "sent", "countered", "accepted", "rejected"

  // Source tracking
  dataSource       String
  sourceId         String?
  enriched         Boolean  @default(false)

  // Metadata
  metadata         String?  // Additional flexible data (JSON string for SQLite)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  user             User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  tasks            Task[]
  dealAnalyses     DealAnalysis[]
  offers           Offer[]
  contracts        Contract[]
  renovations      DealSpec[]     // Renovation projects for this property
  rentals          Rental[]       // Rental properties

  @@unique([userId, address, city, state, zip])
  @@index([userId])
  @@index([score])
  @@index([city, state])
  @@index([createdAt])
  @@index([dataSource])
}

// Task management for investor workflow
model Task {
  id          String   @id @default(cuid())
  userId      String   // Multi-tenant: which investor owns this task
  propertyId  String?  // Optional link to property
  dealId      String?  // Optional link to deal/renovation

  type        String   // "call", "email", "text", "showing", "offer", "follow_up", "custom"
  title       String
  description String?
  dueDate     DateTime
  completed   Boolean  @default(false)
  completedAt DateTime?
  priority    String   @default("medium") // "low", "medium", "high"

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  property    Property? @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  deal        DealSpec? @relation(fields: [dealId], references: [id], onDelete: Cascade)

  @@index([userId, dueDate])
  @@index([userId, completed])
  @@index([propertyId])
  @@index([dealId])
}

// Deal analysis and underwriting
model DealAnalysis {
  id            String   @id @default(cuid())
  userId        String   // Multi-tenant: which investor owns this analysis
  propertyId    String   // Link to property being analyzed

  // ARV (After Repair Value) calculation
  arv           Float
  arvMethod     String   // "median", "weighted", "knn", "manual"
  compsUsed     String?  // JSON array of comparable property data

  // Repair costs
  repairTotal   Float
  repairItems   String?  // JSON array of {category, description, cost}

  // Offer calculation
  maxOffer      Float    // Maximum offer based on rule
  rule          String   @default("70%") // "70%", "75%", "custom"
  offerAmount   Float?   // Actual offer if different from max

  // Purchase and holding costs
  purchasePrice Float?   // Actual purchase price if known
  closingCosts  Float?   // Estimated closing costs
  holdingCosts  Float?   // Monthly holding costs
  holdingMonths Int?     // Expected holding period

  // Profit analysis
  sellingCosts  Float?   // Estimated selling costs (realtor, etc.)
  projectedProfit Float? // Expected profit
  roi           Float?   // Return on investment percentage

  // Metadata
  name          String?  // Optional name for this analysis (e.g., "Conservative", "Aggressive")
  notes         String?  // User notes about this analysis
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  property      Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([propertyId])
}

// Offer management and tracking
model Offer {
  id            String    @id @default(cuid())
  userId        String    // Multi-tenant: which investor owns this offer
  propertyId    String    // Property being offered on
  analysisId    String?   // Optional link to deal analysis

  // Offer details
  amount        Float
  terms         String?   // "cash", "financing", "seller_financing", "subject_to"
  contingencies String?   // JSON array: ["inspection", "financing", "appraisal", "sale_of_home"]
  closingDate   DateTime?
  expiresAt     DateTime? // When offer expires if not accepted
  earnestMoney  Float?    // Earnest money deposit amount
  dueDate       DateTime? // Date offer is due/presented

  // Status tracking
  status        String    @default("draft") // "draft", "sent", "countered", "accepted", "rejected", "expired"
  sentAt        DateTime?
  responseAt    DateTime?
  responseNotes String?   // Notes about seller's response

  // Counter-offer tracking
  counterAmount Float?    // If seller countered
  counterTerms  String?   // JSON with counter-offer details
  counterDate   DateTime?

  // Documentation
  documentUrl   String?   // Link to offer letter/PDF
  notes         String?   // Internal notes about this offer

  // Metadata
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  property      Property  @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  contract      Contract?

  @@index([userId, status])
  @@index([propertyId])
  @@index([status])
  @@index([createdAt])
}

// Contract management and closing tracking
model Contract {
  id              String    @id @default(cuid())
  userId          String    // Multi-tenant: which investor owns this contract
  propertyId      String    // Property under contract
  offerId         String    @unique // Link to accepted offer

  // Contract details
  purchasePrice   Float     // Final purchase price
  status          String    @default("pending") // "pending", "signed", "escrow", "closed", "cancelled"

  // Closing timeline
  signedAt        DateTime?
  escrowOpenedAt  DateTime?
  closingDate     DateTime? // Expected closing date
  closedAt        DateTime? // Actual closing date

  // Documentation
  documentUrls    String?   // JSON array of document links
  notes           String?   // Internal notes

  // Metadata
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  user            User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  property        Property            @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  offer           Offer               @relation(fields: [offerId], references: [id], onDelete: Cascade)
  assignment      ContractAssignment?
  renovation      DealSpec?           // Renovation project for this contract (flippers)
  rental          Rental?             // Rental property for this contract (buy-and-hold)
  buyerOffers     BuyerOffer[]        // Offers from buyers on this contract
  campaigns       Campaign[]          // Marketing campaigns for this contract

  @@index([userId, status])
  @@index([propertyId])
  @@index([status])
  @@index([createdAt])
}

// Buyer database for wholesalers
model Buyer {
  id              String   @id @default(cuid())
  userId          String   // Multi-tenant: which investor (wholesaler) owns this buyer

  // Buyer details
  name            String
  email           String?
  phone           String?
  company         String?

  // Buyer preferences
  propertyTypes   String?  // JSON array: ["single_family", "multi_family"]
  minPrice        Float?
  maxPrice        Float?
  targetMarkets   String?  // JSON array: ["Miami-Dade, FL", "Maricopa, AZ"]
  cashBuyer       Boolean  @default(false)

  // Relationship tracking
  dealsClosed     Int      @default(0)  // Number of deals closed with this buyer
  totalRevenue    Float    @default(0)  // Total assignment fees from this buyer
  reliability     String   @default("unknown") // "unknown", "reliable", "unreliable"

  // Notes
  notes           String?  // Internal notes about this buyer

  // Metadata
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  user            User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  assignments     ContractAssignment[]
  buyerOffers     BuyerOffer[]

  @@index([userId])
  @@index([email])
  @@index([name])
}

// Contract assignment for wholesaling
model ContractAssignment {
  id              String    @id @default(cuid())
  contractId      String    @unique // One-to-one with contract
  buyerId         String    // Which buyer is taking the contract

  // Assignment details
  assignmentFee   Float     // Fee charged for assigning the contract
  assignmentDate  DateTime? // When assignment was signed
  status          String    @default("pending") // "pending", "signed", "closed", "cancelled"

  // Payment tracking
  feeReceived     Boolean   @default(false)
  feeReceivedDate DateTime?

  // Documentation
  documentUrls    String?   // JSON array of assignment agreement documents
  notes           String?   // Internal notes

  // Metadata
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  contract        Contract  @relation(fields: [contractId], references: [id], onDelete: Cascade)
  buyer           Buyer     @relation(fields: [buyerId], references: [id], onDelete: Cascade)

  @@index([buyerId])
  @@index([status])
  @@index([createdAt])
}

// Buyer offers on wholesale deals/contracts
model BuyerOffer {
  id              String    @id @default(cuid())
  userId          String    // Multi-tenant: which investor (wholesaler) owns this
  contractId      String    // Contract being offered on
  buyerId         String    // Buyer making the offer

  // Offer details
  offerPrice      Float     // Buyer's offer price
  terms           String?   // Cash, financing, etc.
  earnestMoney    Float?    // EMD amount
  closingDays     Int?      // Days to close
  contingencies   String?   // JSON array of contingencies
  expiresAt       DateTime? // When offer expires

  // Status tracking
  status          String    @default("submitted") // "submitted", "countered", "accepted", "rejected", "expired"
  submittedAt     DateTime  @default(now())
  responseAt      DateTime?
  responseNotes   String?

  // Counter-offer tracking
  counterAmount   Float?
  counterTerms    String?   // JSON with counter details

  // Notes
  notes           String?

  // Metadata
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  contract        Contract  @relation(fields: [contractId], references: [id], onDelete: Cascade)
  buyer           Buyer     @relation(fields: [buyerId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([contractId])
  @@index([buyerId])
  @@index([status])
  @@index([createdAt])
}

// Marketing campaigns for wholesalers to blast listings to buyers
model Campaign {
  id              String    @id @default(cuid())
  userId          String    // Multi-tenant: which investor owns this campaign
  contractId      String?   // Optional link to a specific contract/listing

  // Campaign details
  name            String
  subject         String?   // Email subject line
  message         String    // Campaign message content
  method          String    @default("email") // "email", "sms", "both"

  // Recipient tracking
  buyerIds        String?   // JSON array of buyer IDs
  recipientCount  Int       @default(0)

  // Delivery tracking
  status          String    @default("draft") // "draft", "scheduled", "sent", "cancelled"
  scheduledAt     DateTime?
  sentAt          DateTime?

  // Performance metrics
  openCount       Int       @default(0)
  clickCount      Int       @default(0)
  replyCount      Int       @default(0)
  offerCount      Int       @default(0)

  // Notes
  notes           String?

  // Metadata
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  contract        Contract? @relation(fields: [contractId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([contractId])
  @@index([status])
  @@index([createdAt])
}

// Rental property management for buy-and-hold investors
model Rental {
  id              String    @id @default(cuid())
  userId          String    // Multi-tenant: which investor owns this rental
  propertyId      String    // Link to property
  contractId      String?   @unique // Link to contract (optional, one-to-one)

  // Rental details
  address         String
  monthlyRent     Float     // Monthly rent amount
  deposit         Float?    // Security deposit amount
  leaseStart      DateTime? // Lease start date
  leaseEnd        DateTime? // Lease end date
  status          String    @default("vacant") // "vacant", "leased", "maintenance", "listed"

  // Financial tracking
  purchasePrice   Float?    // Original purchase price
  mortgagePayment Float?    // Monthly mortgage payment
  propertyTax     Float?    // Monthly property tax
  insurance       Float?    // Monthly insurance
  hoa             Float?    // Monthly HOA fees
  utilities       Float?    // Monthly utilities (if paid by landlord)
  maintenance     Float?    // Estimated monthly maintenance reserve

  // Performance metrics
  totalIncome     Float     @default(0) // Total rental income collected
  totalExpenses   Float     @default(0) // Total expenses paid
  occupancyRate   Float     @default(0) // Percentage of time occupied

  // Notes
  notes           String?   // Internal notes

  // Metadata
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  property        Property  @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  contract        Contract? @relation(fields: [contractId], references: [id], onDelete: SetNull)
  tenants         Tenant[]
  income          RentalIncome[]
  expenses        RentalExpense[]

  @@index([userId])
  @@index([propertyId])
  @@index([contractId])
  @@index([status])
  @@index([createdAt])
}

// Tenant management
model Tenant {
  id              String    @id @default(cuid())
  rentalId        String    // Link to rental property

  // Tenant details
  name            String
  email           String?
  phone           String?
  emergencyContact String?  // JSON: {name, phone, relationship}

  // Lease details
  leaseStart      DateTime
  leaseEnd        DateTime
  monthlyRent     Float
  deposit         Float?
  status          String    @default("active") // "active", "notice_given", "moved_out", "evicted"

  // Move-in/out tracking
  moveInDate      DateTime?
  moveOutDate     DateTime?
  moveOutReason   String?   // "lease_ended", "evicted", "early_termination", "purchased"

  // Payment tracking
  paymentMethod   String?   // "check", "ach", "cash", "online"
  autoPay         Boolean   @default(false)
  latePayments    Int       @default(0) // Count of late payments

  // Notes
  notes           String?   // Internal notes about tenant

  // Metadata
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  rental          Rental    @relation(fields: [rentalId], references: [id], onDelete: Cascade)

  @@index([rentalId])
  @@index([status])
  @@index([leaseEnd])
}

// Rental income tracking
model RentalIncome {
  id              String    @id @default(cuid())
  rentalId        String    // Link to rental property

  // Income details
  amount          Float
  type            String    @default("rent") // "rent", "late_fee", "pet_fee", "parking", "other"
  description     String?
  receivedDate    DateTime
  dueDate         DateTime? // When payment was due (for late tracking)

  // Payment method
  paymentMethod   String?   // "check", "ach", "cash", "online"
  referenceNumber String?   // Check number, transaction ID, etc.

  // Metadata
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  rental          Rental    @relation(fields: [rentalId], references: [id], onDelete: Cascade)

  @@index([rentalId])
  @@index([receivedDate])
  @@index([type])
}

// Rental expense tracking
model RentalExpense {
  id              String    @id @default(cuid())
  rentalId        String    // Link to rental property

  // Expense details
  amount          Float
  category        String    // "mortgage", "tax", "insurance", "hoa", "maintenance", "utilities", "other"
  description     String?
  expenseDate     DateTime

  // Payment tracking
  paid            Boolean   @default(false)
  paidDate        DateTime?
  paymentMethod   String?   // "check", "ach", "credit_card", "cash"
  referenceNumber String?   // Check number, transaction ID, etc.

  // Documentation
  receiptUrl      String?   // Link to receipt/invoice

  // Metadata
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  rental          Rental    @relation(fields: [rentalId], references: [id], onDelete: Cascade)

  @@index([rentalId])
  @@index([expenseDate])
  @@index([category])
  @@index([paid])
}

// Notification and event tracking
model Notification {
  id          String   @id @default(cuid())
  eventId     String   @unique
  type        String   // g1.denied, property.alert, etc.
  dealId      String?
  message     String
  metadata    String?  // Flexible metadata including dedupe_hash (JSON string for SQLite)
  occurredAt  DateTime @default(now())
  createdAt   DateTime @default(now())
  n8nExecId   String?  // n8n execution ID
  n8nWorkflow String?  // n8n workflow name
  processed   Boolean  @default(false)

  @@index([type, occurredAt])
  @@index([dealId])
  @@index([processed])
}

// =============================================================================
// VENDOR NETWORK SYSTEM
// =============================================================================
// Architecture:
// - PlatformVendor: Shared vendors sourced from APIs (Google Places), associated with markets
// - UserVendor: Private vendors created by individual users
// - UserVendorRelationship: Junction linking users to platform vendors with user-specific data
// - VendorJob: Track work history with both vendor types
// =============================================================================

// Vendor trade categories - comprehensive list for real estate renovation
enum VendorCategory {
  GENERAL_CONTRACTOR
  ROOFER
  PLUMBER
  ELECTRICIAN
  HVAC
  FLOORING
  PAINTER
  LANDSCAPER
  DUMPSTER_RENTAL
  LOCKSMITH
  CLEANING_SERVICE
  HOME_INSPECTOR
  APPRAISER
  DEMOLITION
  FRAMING
  SIDING
  WINDOWS
  INSULATION
  DRYWALL
  KITCHEN
  BATHROOM
  FENCING
  CONCRETE
  POOL
  PEST_CONTROL
  GARAGE_DOOR
  APPLIANCE_REPAIR
  OTHER
}

// Source of vendor data for attribution and refresh tracking
enum VendorSource {
  GOOGLE_PLACES   // Primary source: Google Places API
  YELP            // Alternative: Yelp API
  MANUAL          // Manually entered by admin
  PARTNER         // Future: verified partner vendors
}

// Vendor operational status
enum VendorStatus {
  ACTIVE          // Currently operating
  INACTIVE        // Temporarily not operating
  CLOSED          // Permanently closed
  UNVERIFIED      // Needs verification
}

// Market/Metro area for geographic vendor grouping
// Platform vendors are associated with markets, shared across all users in that market
model Market {
  id          String   @id @default(cuid())
  name        String   // Display name: "Jacksonville, FL"
  city        String   // City name for matching
  state       String   // State code (FL, AZ, etc.)
  country     String   @default("US")

  // Geographic center for radius-based queries
  latitude    Float?
  longitude   Float?
  radiusMiles Int      @default(50) // Default search radius

  // Market status
  isActive    Boolean  @default(true) // Whether we're actively sourcing vendors here

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  platformVendors PlatformVendor[]

  @@unique([city, state, country])
  @@index([state])
  @@index([isActive])
}

// Platform-sourced vendors (shared across all users in a market)
// These are pre-populated from public data sources (Google Places API)
// No duplication per user - users create relationships to add to their list
model PlatformVendor {
  id              String           @id @default(cuid())

  // === Basic Business Info ===
  name            String
  description     String?          // Business description from source

  // === Location ===
  address         String?          // Full street address
  city            String
  state           String
  zip             String?
  latitude        Float?           // For map display and distance calculations
  longitude       Float?

  // === Contact Info ===
  phone           String?
  email           String?          // Often not available from Google
  website         String?

  // === Categorization ===
  // Using array of enums for multi-trade vendors (e.g., GC who does plumbing)
  categories      VendorCategory[]

  // === Source & External IDs ===
  source          VendorSource     @default(GOOGLE_PLACES)
  googlePlaceId   String?          @unique // Google Places unique ID
  yelpId          String?          @unique // Yelp business ID

  // === Public Ratings (from source) ===
  sourceRating      Float?         // e.g., Google rating 4.5 (1-5 scale)
  sourceReviewCount Int?           // e.g., 127 reviews
  priceLevel        Int?           // Google price level 1-4 ($ to $$$$)

  // === Business Details ===
  licenseNumber     String?        // Contractor license if available
  insuranceVerified Boolean        @default(false)
  yearsInBusiness   Int?

  // === Status & Verification ===
  status          VendorStatus     @default(ACTIVE)
  isVerified      Boolean          @default(false) // FlipOps manual verification
  isPartner       Boolean          @default(false) // Future: partner program
  partnerDiscount Float?           // Future: discount percentage for FlipOps users

  // === Data Freshness ===
  lastRefreshedAt DateTime?        // When data was last pulled from source
  refreshFailCount Int             @default(0) // Track consecutive refresh failures

  // === Soft Delete ===
  deletedAt       DateTime?        // Soft delete - don't hard delete if has job history

  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  // === Relations ===
  marketId        String
  market          Market           @relation(fields: [marketId], references: [id])

  userRelationships UserVendorRelationship[]

  // Indexes for common queries
  @@index([marketId])
  @@index([marketId, status])
  @@index([categories])
  @@index([googlePlaceId])
  @@index([city, state])
  @@index([sourceRating])
  @@index([deletedAt])
}

// User-created private vendors (not from platform, user's personal contacts)
// These belong to a single user and are not shared
model UserVendor {
  id              String           @id @default(cuid())

  // === Owner ===
  userId          String
  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  // === Basic Business Info ===
  name            String
  description     String?
  contactName     String?          // Primary contact person at the company

  // === Location (optional for private vendors) ===
  address         String?
  city            String?
  state           String?
  zip             String?

  // === Contact Info ===
  phone           String?
  email           String?
  website         String?

  // === Categorization ===
  categories      VendorCategory[]
  tags            String[]         // Custom user tags (e.g., "reliable", "cheap", "fast")

  // === Business Details ===
  licenseNumber     String?
  insuranceVerified Boolean        @default(false)

  // === User's Assessment ===
  personalRating    Float?         // User's rating 1-5 (separate from any public rating)
  notes             String?        // User's private notes
  isFavorite        Boolean        @default(false)
  isPreferred       Boolean        @default(false) // Preferred vendor for their category

  // === Availability ===
  availabilityStatus String?       // "available", "busy", "unavailable", "unknown"

  // === Soft Delete ===
  deletedAt       DateTime?        // Soft delete - preserve job history

  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  // === Relations ===
  jobs            VendorJob[]

  @@index([userId])
  @@index([userId, deletedAt])
  @@index([categories])
  @@index([isFavorite])
}

// Junction table: User's relationship with a platform vendor
// This is created when a user "adds" a platform vendor to their personal list
// Stores user-specific data (notes, personal rating, etc.) without duplicating vendor data
model UserVendorRelationship {
  id                String         @id @default(cuid())

  // === User ===
  userId            String
  user              User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  // === Platform Vendor ===
  platformVendorId  String
  platformVendor    PlatformVendor @relation(fields: [platformVendorId], references: [id])

  // === User-Specific Data ===
  personalRating    Float?         // User's rating 1-5 (separate from Google rating)
  notes             String?        // User's private notes about this vendor
  tags              String[]       // User's custom tags for this vendor
  isFavorite        Boolean        @default(false)
  isPreferred       Boolean        @default(false) // Preferred vendor for this category

  // === Contact Override ===
  // If user has different/better contact info than what's in platform data
  contactName       String?        // Specific person the user works with
  contactPhone      String?        // Direct line vs main business number
  contactEmail      String?

  // === Relationship Tracking ===
  addedAt           DateTime       @default(now()) // When user added this vendor
  lastContactedAt   DateTime?      // Last time user contacted this vendor
  lastUsedAt        DateTime?      // Last time vendor was assigned a job

  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  // === Relations ===
  jobs              VendorJob[]

  // Composite unique: one relationship per user per platform vendor
  @@unique([userId, platformVendorId])
  @@index([userId])
  @@index([platformVendorId])
  @@index([userId, isFavorite])
  @@index([userId, isPreferred])
}

// Track jobs/projects with vendors (works with both user vendors and platform relationships)
// This enables job history tracking for future features
model VendorJob {
  id              String         @id @default(cuid())

  // === Owner ===
  userId          String
  user            User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  // === Vendor Link (one of these will be set) ===
  userVendorId              String?
  userVendor                UserVendor?              @relation(fields: [userVendorId], references: [id])

  userVendorRelationshipId  String?
  userVendorRelationship    UserVendorRelationship?  @relation(fields: [userVendorRelationshipId], references: [id])

  // === Link to Deal/Renovation (optional) ===
  dealId          String?
  deal            DealSpec?      @relation(fields: [dealId], references: [id])

  // === Job Details ===
  title           String         // Job title/description
  description     String?        // Detailed description
  category        VendorCategory? // Trade category for this job

  // === Financials ===
  quotedAmount    Float?         // Original quote
  finalAmount     Float?         // Final amount paid

  // === Timeline ===
  scheduledDate   DateTime?      // When job is scheduled
  startDate       DateTime?      // When work started
  completedDate   DateTime?      // When work completed

  // === Assessment (after completion) ===
  qualityRating       Int?       // 1-5 rating for work quality
  timelinessRating    Int?       // 1-5 rating for meeting schedule
  communicationRating Int?       // 1-5 rating for communication
  wouldRecommend      Boolean?   // Would user recommend this vendor?
  reviewNotes         String?    // User's review/notes about the job

  // === Status ===
  status          String         @default("pending") // pending, scheduled, in_progress, completed, cancelled

  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@index([userId])
  @@index([userVendorId])
  @@index([userVendorRelationshipId])
  @@index([dealId])
  @@index([status])
  @@index([completedDate])
}

// =============================================================================
// TEAM MANAGEMENT SYSTEM
// =============================================================================
// Architecture:
// - Team: An organization/company with multiple members
// - TeamMember: Links users to teams with roles and permissions
// - TeamInvite: Pending invitations to join a team
// - Activity: Tracks team member activities for performance analytics
// =============================================================================

// Team roles for access control
enum TeamRole {
  OWNER       // Full admin rights, can delete team
  ADMIN       // Can manage members, settings
  MANAGER     // Can view all deals, assign work
  MEMBER      // Standard access to own work
  VIEWER      // Read-only access
}

// Team/Organization
model Team {
  id              String       @id @default(cuid())
  name            String       // Team/Company name
  slug            String       @unique // URL-friendly identifier
  description     String?      // Team description
  logo            String?      // Logo URL

  // Billing
  tier            String       @default("pro") // free, pro, enterprise
  subscriptionId  String?      // Stripe subscription ID

  // Settings (JSON for flexibility)
  settings        String?      // JSON: { timezone, workingHours, notifications, etc. }

  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  // Relations
  members         TeamMember[]
  invites         TeamInvite[]
  activities      Activity[]

  @@index([slug])
}

// Team membership - links users to teams
model TeamMember {
  id              String       @id @default(cuid())
  teamId          String
  userId          String       // Links to User model (via clerkId or id)

  // Member info (cached from User for display)
  name            String
  email           String
  avatar          String?      // Profile picture URL

  // Role and permissions
  role            TeamRole     @default(MEMBER)
  department      String?      // "Acquisition", "Disposition", "Account Manager", etc.
  title           String?      // Job title

  // Status
  isActive        Boolean      @default(true)
  joinedAt        DateTime     @default(now())
  lastActiveAt    DateTime?

  // Performance targets (optional)
  dailyTouchTarget    Int?     // Target calls/touches per day
  monthlyDealTarget   Int?     // Target deals per month
  responseTimeTarget  Int?     // Target response time in minutes

  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  // Relations
  team            Team         @relation(fields: [teamId], references: [id], onDelete: Cascade)
  activities      Activity[]

  @@unique([teamId, userId])
  @@unique([teamId, email])
  @@index([teamId])
  @@index([userId])
  @@index([teamId, role])
  @@index([teamId, isActive])
}

// Pending team invitations
model TeamInvite {
  id              String       @id @default(cuid())
  teamId          String
  email           String       // Invited email address

  // Invite details
  role            TeamRole     @default(MEMBER)
  department      String?
  title           String?

  // Invite tracking
  invitedBy       String       // User ID who sent invite
  invitedAt       DateTime     @default(now())
  expiresAt       DateTime     // Invite expiration

  // Status
  status          String       @default("pending") // pending, accepted, expired, cancelled
  acceptedAt      DateTime?

  // Token for secure invite link
  token           String       @unique @default(cuid())

  // Relations
  team            Team         @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([teamId, email, status]) // One pending invite per email per team
  @@index([teamId])
  @@index([email])
  @@index([token])
  @@index([status])
}

// Activity tracking for team performance analytics
model Activity {
  id              String       @id @default(cuid())
  teamId          String
  memberId        String       // TeamMember ID

  // Activity details
  type            String       // "call", "sms", "email", "appointment", "offer", "note", "task"
  outcome         String?      // "connected", "no_answer", "left_vm", "wrong_number", "scheduled", "completed"

  // Related entities (optional links)
  propertyId      String?      // If activity is on a property/lead
  dealId          String?      // If activity is on a deal
  contractId      String?      // If activity is on a contract

  // Activity metadata
  duration        Int?         // Duration in seconds (for calls)
  notes           String?      // Activity notes
  sentiment       String?      // "positive", "neutral", "negative"

  // Response tracking
  isFirstContact  Boolean      @default(false) // Was this the first contact?
  responseTime    Int?         // Time to respond in minutes (from lead creation)

  // Timestamps
  occurredAt      DateTime     @default(now()) // When activity happened
  createdAt       DateTime     @default(now())

  // Relations
  team            Team         @relation(fields: [teamId], references: [id], onDelete: Cascade)
  member          TeamMember   @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([teamId])
  @@index([memberId])
  @@index([teamId, occurredAt])
  @@index([memberId, occurredAt])
  @@index([type])
  @@index([propertyId])
  @@index([dealId])
}
