# Railway.app Configuration for FlipOps TypeScript Cron Jobs
# Documentation: https://docs.railway.app/reference/config-as-code

[build]
  # Build the Next.js application
  builder = "nixpacks"
  buildCommand = "npm run build"

[deploy]
  # Start the Next.js production server
  startCommand = "npm run start"
  # Health check endpoint
  healthcheckPath = "/api/health"
  healthcheckTimeout = 100
  # Restart policy
  restartPolicyType = "on_failure"
  restartPolicyMaxRetries = 10

# Environment variables required for deployment
# Set these in Railway dashboard -> Variables tab:
# - DATABASE_URL (PostgreSQL connection string)
# - ATTOM_API_KEY (for property discovery)
# - BATCHDATA_API_KEY (for skip tracing)
# - NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY
# - CLERK_SECRET_KEY
# - All other existing environment variables

# ============================================================================
# CRON JOBS - TypeScript Workflow Automation
# ============================================================================

# ----------------------------------------------------------------------------
# Monitoring Workflows (Daily)
# ----------------------------------------------------------------------------

[[crons]]
  # Data Refresh & Sync - Daily at 8 AM
  name = "data-refresh-sync"
  schedule = "0 8 * * *"
  command = "npm run cron:data-refresh"

[[crons]]
  # Pipeline Monitoring - Daily at 9 AM
  name = "pipeline-monitoring"
  schedule = "0 9 * * *"
  command = "npm run cron:pipeline"

[[crons]]
  # Contractor Performance Tracking - Daily at 10 AM
  name = "contractor-performance"
  schedule = "0 10 * * *"
  command = "npm run cron:contractors"

# ----------------------------------------------------------------------------
# Guardrail Workflows (Every 15 minutes)
# ----------------------------------------------------------------------------

[[crons]]
  # G1 - Deal Approval Alert (P80 > maxExposure)
  name = "guardrail-g1-deal-approval"
  schedule = "*/15 * * * *"
  command = "npm run cron:g1"

[[crons]]
  # G2 - Bid Spread Alert (Spread > 15%)
  name = "guardrail-g2-bid-spread"
  schedule = "*/15 * * * *"
  command = "npm run cron:g2"

[[crons]]
  # G3 - Invoice & Budget Guardian
  name = "guardrail-g3-invoice-budget"
  schedule = "*/15 * * * *"
  command = "npm run cron:g3"

[[crons]]
  # G4 - Change Order Gatekeeper
  name = "guardrail-g4-change-order"
  schedule = "*/15 * * * *"
  command = "npm run cron:g4"

# ----------------------------------------------------------------------------
# Discovery Workflows
# ----------------------------------------------------------------------------

[[crons]]
  # ATTOM Property Discovery - Daily at 6 AM
  # Discovers investment properties using ATTOM API
  # Cost: ATTOM API credits (varies by plan)
  name = "attom-property-discovery"
  schedule = "0 6 * * *"
  command = "npm run cron:attom"

[[crons]]
  # Skip Tracing & Enrichment - Weekly on Sundays at 7 AM
  # Enriches high-scoring properties with contact info via BatchData
  # Cost: $0.20 per property (batches of 25)
  name = "skip-tracing-enrichment"
  schedule = "0 7 * * 0"
  command = "npm run cron:skip-trace"

# ============================================================================
# CRON SCHEDULE REFERENCE
# ============================================================================
#
# Format: "minute hour day month weekday"
#
# Examples:
# - "*/15 * * * *"   = Every 15 minutes
# - "0 8 * * *"      = Daily at 8:00 AM
# - "0 */6 * * *"    = Every 6 hours
# - "0 0 * * 0"      = Weekly on Sundays at midnight
# - "0 9 * * 1-5"    = Weekdays at 9:00 AM
#
# ============================================================================
# DEPLOYMENT CHECKLIST
# ============================================================================
#
# Before deploying:
#
# 1. Environment Variables (Railway Dashboard -> Variables)
#    ✓ DATABASE_URL
#    ✓ ATTOM_API_KEY
#    ✓ BATCHDATA_API_KEY
#    ✓ NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY
#    ✓ CLERK_SECRET_KEY
#    ✓ (All other existing variables from .env)
#
# 2. Database Setup
#    ✓ PostgreSQL database provisioned
#    ✓ Prisma migrations applied
#    ✓ Test data seeded (optional)
#
# 3. Testing
#    ✓ Test locally: npm run cron:<workflow-name>
#    ✓ Verify Slack notifications work
#    ✓ Check Prisma connections
#
# 4. Deployment
#    ✓ Push railway.toml to repository
#    ✓ Deploy via Railway dashboard or CLI
#    ✓ Monitor Railway Logs tab for errors
#    ✓ Verify cron jobs appear in Railway Jobs tab
#
# 5. Post-Deployment Monitoring (1 week)
#    ✓ Watch Slack notifications
#    ✓ Check Railway logs daily
#    ✓ Keep n8n running as backup
#    ✓ Monitor costs (BatchData usage)
#
# 6. n8n Decommission (After 1 week)
#    ✓ Export n8n workflows as final backup
#    ✓ Delete n8n Railway instance
#    ✓ Save $10-15/month
#
# ============================================================================
# COST BREAKDOWN
# ============================================================================
#
# Railway Costs (assuming existing plan):
# - Next.js app: Already running ($0 additional)
# - Cron jobs: Included in plan ($0 additional)
# - PostgreSQL: Already provisioned ($0 additional)
# - Total Railway: $0 additional
#
# External API Costs:
# - ATTOM API: Varies by plan (check ATTOM pricing)
# - BatchData: $0.20 per property
#   - 25 properties/week = $5/week = $260/year
#   - 50 properties/week = $10/week = $520/year
#
# Cost Savings (n8n removal):
# - n8n instance: -$10-15/month = -$120-180/year
#
# Net Cost Change: Break-even to slight savings
#
# ============================================================================
# MONITORING & ALERTS
# ============================================================================
#
# Railway Dashboard -> Logs:
# - Filter by workflow name
# - Check for errors (red ❌ logs)
# - Monitor execution times
#
# Railway Dashboard -> Jobs:
# - View all cron job runs
# - Check success/failure status
# - See next scheduled run times
#
# Slack Notifications:
# - All workflows send Slack alerts
# - Check #flipops-alerts channel (or configured channel)
# - Alerts include execution summaries
#
# ============================================================================
