{
  "name": "Miami-Dade Foreclosure Parser",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "expression": "0 2 * * *"
            }
          ]
        }
      },
      "id": "a1a1a1a1-1111-1111-1111-111111111111",
      "name": "Daily 2AM Trigger",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.1,
      "position": [250, 300]
    },
    {
      "parameters": {
        "url": "https://www.miamidade.gov/information/foreclosure-sales.asp",
        "authentication": "none",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "User-Agent",
              "value": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36"
            },
            {
              "name": "Accept",
              "value": "text/html,application/xhtml+xml"
            },
            {
              "name": "Accept-Language",
              "value": "en-US,en;q=0.9"
            }
          ]
        },
        "options": {
          "timeout": 30000,
          "retry": {
            "maxTries": 3,
            "waitBetweenTries": 2000
          },
          "redirect": {
            "redirect": {
              "followRedirects": true,
              "maxRedirects": 5
            }
          }
        }
      },
      "id": "b2b2b2b2-2222-2222-2222-222222222222",
      "name": "Fetch County Page",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [450, 300]
    },
    {
      "parameters": {
        "extractionValues": {
          "values": [
            {
              "key": "foreclosure_rows",
              "cssSelector": "table.foreclosure-list tbody tr, .property-table tr, #foreclosure-data tr",
              "returnValue": "html",
              "multiple": true
            }
          ]
        },
        "options": {}
      },
      "id": "c3c3c3c3-3333-3333-3333-333333333333",
      "name": "Extract Table Rows",
      "type": "n8n-nodes-base.htmlExtract",
      "typeVersion": 1,
      "position": [650, 300]
    },
    {
      "parameters": {
        "jsCode": "// Parse foreclosure data from HTML rows\nconst properties = [];\nconst seenAddresses = new Set();\n\nfor (const item of $input.all()) {\n  const html = item.json.foreclosure_rows || '';\n  \n  // Primary extraction patterns\n  const patterns = [\n    // Pattern 1: Table cells\n    /<td[^>]*>([^<]+)<\\/td>/gi,\n    // Pattern 2: Direct text between tags\n    />([^<>]+)</g,\n    // Pattern 3: Fallback for any address-like content\n    /(\\d+\\s+[A-Za-z\\s]+(?:St|Street|Ave|Avenue|Rd|Road|Dr|Drive|Blvd|Boulevard|Way|Court|Ct|Lane|Ln|Place|Pl))(?:[^,]*,\\s*([A-Za-z\\s]+)\\s+(FL|Florida))?/gi\n  ];\n  \n  let cells = [];\n  \n  // Try primary extraction\n  const cellMatches = html.matchAll(patterns[0]);\n  for (const match of cellMatches) {\n    const text = match[1].trim();\n    if (text && !text.includes('<') && !text.includes('>')) {\n      cells.push(text);\n    }\n  }\n  \n  // If no cells found, try fallback pattern\n  if (cells.length < 3) {\n    const addressMatch = patterns[2].exec(html);\n    if (addressMatch) {\n      cells = [\n        addressMatch[1], // Address\n        addressMatch[2] || 'Miami', // City\n        'Unknown', // Owner placeholder\n        new Date().toISOString().split('T')[0] // Sale date placeholder\n      ];\n    }\n  }\n  \n  // Parse cells into property object\n  if (cells.length >= 2) {\n    const property = {\n      address: cells[0] || '',\n      city: cells[1] || 'Miami',\n      state: 'FL',\n      zip: cells[2] || extractZip(cells) || '',\n      ownerName: cells[3] || cells[4] || 'Unknown',\n      \n      // All foreclosures get these flags\n      foreclosure: true,\n      preForeclosure: false,\n      taxDelinquent: checkTaxStatus(html),\n      vacant: checkVacancy(html),\n      bankruptcy: checkBankruptcy(html),\n      absenteeOwner: false,\n      \n      // Metadata\n      saleDate: extractDate(cells) || extractDate(html),\n      caseNumber: extractCaseNumber(html),\n      source: 'miami_dade_county',\n      importedAt: new Date().toISOString()\n    };\n    \n    // Dedupe by address\n    const addressKey = `${property.address}_${property.city}`.toLowerCase();\n    if (!seenAddresses.has(addressKey) && property.address) {\n      seenAddresses.add(addressKey);\n      properties.push(property);\n    }\n  }\n}\n\n// Helper functions\nfunction extractZip(cells) {\n  for (const cell of cells) {\n    const zipMatch = /\\b(\\d{5})(?:-\\d{4})?\\b/.exec(cell);\n    if (zipMatch) return zipMatch[1];\n  }\n  return '';\n}\n\nfunction extractDate(input) {\n  const text = Array.isArray(input) ? input.join(' ') : input;\n  const datePattern = /\\b(\\d{1,2})[\\/\\-](\\d{1,2})[\\/\\-](\\d{2,4})\\b/;\n  const match = datePattern.exec(text);\n  if (match) {\n    const [_, month, day, year] = match;\n    const fullYear = year.length === 2 ? `20${year}` : year;\n    return `${fullYear}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;\n  }\n  return null;\n}\n\nfunction extractCaseNumber(html) {\n  const casePattern = /\\b(\\d{4}-\\d{4,6}|\\d{2}-\\d{5})\\b/;\n  const match = casePattern.exec(html);\n  return match ? match[1] : null;\n}\n\nfunction checkTaxStatus(html) {\n  return /tax[\\s\\-]?(delinquent|lien|certificate)/i.test(html);\n}\n\nfunction checkVacancy(html) {\n  return /\\b(vacant|abandoned|unoccupied)\\b/i.test(html);\n}\n\nfunction checkBankruptcy(html) {\n  return /\\b(bankruptcy|chapter\\s*7|chapter\\s*13)\\b/i.test(html);\n}\n\n// Return parsed properties\nreturn properties.map(p => ({ json: p }));"
      },
      "id": "d4d4d4d4-4444-4444-4444-444444444444",
      "name": "Parse Property Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [850, 300]
    },
    {
      "parameters": {
        "jsCode": "// Dedupe properties by creating hash of address+date\nconst crypto = require('crypto');\nconst dedupedProperties = [];\nconst hashes = new Set();\n\nfor (const item of $input.all()) {\n  const property = item.json;\n  \n  // Create unique hash\n  const hashInput = `${property.address}_${property.city}_${property.state}_${property.zip}_${new Date().toISOString().split('T')[0]}`;\n  const hash = crypto.createHash('md5').update(hashInput.toLowerCase()).digest('hex');\n  \n  // Check if we've seen this property today\n  if (!hashes.has(hash)) {\n    hashes.add(hash);\n    property.dedupe_hash = hash;\n    dedupedProperties.push({ json: property });\n  }\n}\n\nreturn dedupedProperties;"
      },
      "id": "e5e5e5e5-5555-5555-5555-555555555555",
      "name": "Dedupe Properties",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1050, 300]
    },
    {
      "parameters": {
        "url": "={{ $env.FO_API_BASE_URL }}/webhooks/n8n",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "x-api-key",
              "value": "={{ $env.FO_API_KEY }}"
            }
          ]
        },
        "sendBody": true,
        "bodyContentType": "json",
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json) }}",
        "options": {
          "batching": {
            "batch": {
              "batchSize": 25,
              "batchInterval": 2000
            }
          },
          "timeout": 9000,
          "retry": {
            "maxTries": 2,
            "waitBetweenTries": 4000
          }
        }
      },
      "id": "f6f6f6f6-6666-6666-6666-666666666666",
      "name": "Batch Send to FlipOps",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1250, 300]
    },
    {
      "parameters": {
        "conditions": {
          "number": [
            {
              "value1": "={{ $json.score }}",
              "operation": "largerEqual",
              "value2": 80
            }
          ]
        }
      },
      "id": "g7g7g7g7-7777-7777-7777-777777777777",
      "name": "Filter High Scores",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [1450, 300]
    },
    {
      "parameters": {
        "channel": "={{ $env.SLACK_ALERTS_CHANNEL_ID }}",
        "messageType": "block",
        "blocksUi": {
          "blocks": [
            {
              "type": "header",
              "text": {
                "type": "plain_text",
                "text": "ðŸ›ï¸ Miami-Dade Foreclosure Alert"
              }
            },
            {
              "type": "section",
              "text": {
                "type": "mrkdwn",
                "text": "*New foreclosure property scored {{ $json.score }}/100*"
              },
              "fields": [
                {
                  "type": "mrkdwn",
                  "text": "*Address:*\n{{ $json.address }}"
                },
                {
                  "type": "mrkdwn",
                  "text": "*Location:*\n{{ $json.city }}, {{ $json.state }}"
                },
                {
                  "type": "mrkdwn",
                  "text": "*Sale Date:*\n{{ $json.saleDate || 'TBD' }}"
                },
                {
                  "type": "mrkdwn",
                  "text": "*Case #:*\n{{ $json.caseNumber || 'N/A' }}"
                }
              ]
            },
            {
              "type": "context",
              "elements": [
                {
                  "type": "mrkdwn",
                  "text": "Source: Miami-Dade County Foreclosures | Score: {{ $json.score }}/100"
                }
              ]
            },
            {
              "type": "actions",
              "elements": [
                {
                  "type": "button",
                  "text": {
                    "type": "plain_text",
                    "text": "Research Property"
                  },
                  "url": "{{ $env.FO_PANEL_BASE_URL }}/properties/{{ encodeURIComponent($json.address) }}",
                  "style": "primary"
                }
              ]
            }
          ]
        }
      },
      "id": "h8h8h8h8-8888-8888-8888-888888888888",
      "name": "Alert High Scores",
      "type": "n8n-nodes-base.slack",
      "typeVersion": 2.1,
      "position": [1650, 250],
      "credentials": {
        "slackApi": {
          "id": "2",
          "name": "Slack account"
        }
      }
    },
    {
      "parameters": {
        "url": "={{ $env.FO_API_BASE_URL }}/notifications",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "x-api-key",
              "value": "={{ $env.FO_API_KEY }}"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"eventId\": \"evt_county_{{ $now.toUnix() }}_{{ $json.dedupe_hash }}\",\n  \"type\": \"property.foreclosure\",\n  \"message\": \"Miami-Dade foreclosure: {{ $json.address }}\",\n  \"metadata\": {\n    \"source\": \"miami_dade_county\",\n    \"score\": {{ $json.score }},\n    \"address\": \"{{ $json.address }}\",\n    \"city\": \"{{ $json.city }}\",\n    \"saleDate\": \"{{ $json.saleDate }}\",\n    \"caseNumber\": \"{{ $json.caseNumber }}\",\n    \"dedupe_hash\": \"{{ $json.dedupe_hash }}\",\n    \"processed_count\": {{ $items().length }}\n  },\n  \"n8nExecId\": \"{{ $execution.id }}\",\n  \"n8nWorkflow\": \"{{ $workflow.name }}\"\n}",
        "options": {
          "timeout": 5000
        }
      },
      "id": "i9i9i9i9-9999-9999-9999-999999999999",
      "name": "Log Summary",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1850, 300]
    },
    {
      "parameters": {
        "triggerOn": "workflowError"
      },
      "id": "j0j0j0j0-0000-0000-0000-000000000000",
      "name": "Error Handler",
      "type": "n8n-nodes-base.errorTrigger",
      "typeVersion": 1,
      "position": [250, 500]
    },
    {
      "parameters": {
        "channel": "#automation-errors",
        "text": "âŒ Miami-Dade Parser Error\n\nWorkflow: {{ $workflow.name }}\nExecution: {{ $execution.id }}\nTime: {{ $now.toISO() }}\n\nError: {{ $json.error.message || $json.error }}\nNode: {{ $json.error.node || 'Unknown' }}\n\nPlease check the execution logs for details.",
        "options": {}
      },
      "id": "k1k1k1k1-1111-1111-1111-111111111112",
      "name": "Error Notification",
      "type": "n8n-nodes-base.slack",
      "typeVersion": 2.1,
      "position": [450, 500],
      "credentials": {
        "slackApi": {
          "id": "2",
          "name": "Slack account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Fallback parser if HTML extraction fails\nconst properties = [];\nconst rawHtml = $input.first().json.data || $input.first().json.html || '';\n\n// Aggressive regex patterns for foreclosure data\nconst patterns = [\n  // Address pattern\n  /(\\d{1,5}\\s+[A-Za-z0-9\\s]+(?:Street|St|Avenue|Ave|Road|Rd|Drive|Dr|Boulevard|Blvd|Way|Court|Ct|Lane|Ln|Place|Pl|Circle|Cir|Terrace|Ter))\\b/gi,\n  // Case number pattern\n  /\\b(\\d{4}-\\d{4,6}|\\d{2}-\\d{5})\\b/g,\n  // Date pattern\n  /\\b(\\d{1,2})[\\/\\-](\\d{1,2})[\\/\\-](\\d{2,4})\\b/g\n];\n\nconst addresses = [...rawHtml.matchAll(patterns[0])].map(m => m[1]);\nconst caseNumbers = [...rawHtml.matchAll(patterns[1])].map(m => m[1]);\nconst dates = [...rawHtml.matchAll(patterns[2])].map(m => m[0]);\n\n// Create properties from extracted data\nfor (let i = 0; i < addresses.length; i++) {\n  properties.push({\n    address: addresses[i],\n    city: 'Miami',\n    state: 'FL',\n    zip: '',\n    ownerName: 'Unknown',\n    foreclosure: true,\n    caseNumber: caseNumbers[i] || null,\n    saleDate: dates[i] || null,\n    source: 'miami_dade_county_fallback',\n    importedAt: new Date().toISOString()\n  });\n}\n\nif (properties.length === 0) {\n  // Log error but don't fail workflow\n  console.error('No properties extracted from Miami-Dade page');\n  return [{ json: { error: 'No data extracted', timestamp: new Date().toISOString() } }];\n}\n\nreturn properties.map(p => ({ json: p }));"
      },
      "id": "l2l2l2l2-2222-2222-2222-222222222223",
      "name": "Fallback Parser",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [650, 400],
      "disabled": true
    }
  ],
  "connections": {
    "Daily 2AM Trigger": {
      "main": [
        [
          {
            "node": "Fetch County Page",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch County Page": {
      "main": [
        [
          {
            "node": "Extract Table Rows",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Table Rows": {
      "main": [
        [
          {
            "node": "Parse Property Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Property Data": {
      "main": [
        [
          {
            "node": "Dedupe Properties",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Dedupe Properties": {
      "main": [
        [
          {
            "node": "Batch Send to FlipOps",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Batch Send to FlipOps": {
      "main": [
        [
          {
            "node": "Filter High Scores",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filter High Scores": {
      "main": [
        [
          {
            "node": "Alert High Scores",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Log Summary",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Alert High Scores": {
      "main": [
        [
          {
            "node": "Log Summary",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Error Handler": {
      "main": [
        [
          {
            "node": "Error Notification",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {},
  "tags": []
}